<div class="family-container" style="color: #e2e8f0; font-family: 'Montserrat', sans-serif; max-width: 450px; margin: auto; padding: 20px;">
    
    <button id="pwa-btn" style="display:none; width:100%; padding:15px; background:#f5b942; border:none; border-radius:15px; font-weight:800; margin-bottom:20px; cursor:pointer; font-family: 'Montserrat';">
        <i class="fas fa-home"></i> ANA EKRANA ∆èLAV∆è ET
    </button>

    <div id="setup-screen" class="glass-panel" style="background:rgba(20,22,30,0.95); padding:30px; border-radius:30px; border:1px solid #c5a059; text-align:center;">
        <h2 style="font-family:'Playfair Display', serif; color:#f5b942; margin-bottom:10px;">Ail…ô Ocaƒüƒ±</h2>
        <p style="font-size:0.8rem; color:#888; margin-bottom:25px;">Otaq kodu yaradƒ±n v…ô ya m√∂vcud koda qo≈üulun.</p>
        
        <input type="text" id="room-code-input" placeholder="Ail…ô Kodu (m…ôs: bizimlider)" style="width:100%; padding:15px; background:#000; border:1px solid #333; border-radius:12px; color:#fff; margin-bottom:20px; text-align:center; font-size:1rem;">
        
        <div id="new-baby-setup" style="display:none; margin-bottom:20px; border-top:1px solid #222; padding-top:20px;">
            <input type="text" id="baby-name-in" placeholder="K√∂rp…ônin Adƒ±" style="width:100%; padding:12px; background:#111; border:1px solid #333; border-radius:10px; color:#fff; margin-bottom:15px; text-align:center;">
            <div style="display:flex; gap:10px;">
                <button class="choice-btn" id="btn-boy" onclick="setGender('boy')">OƒûLAN</button>
                <button class="choice-btn" id="btn-girl" onclick="setGender('girl')">QIZ</button>
            </div>
        </div>

        <button onclick="handleRoomAccess()" style="width:100%; padding:18px; background:#f5b942; color:#000; border:none; border-radius:12px; font-weight:800; cursor:pointer; text-transform:uppercase;">Giri≈ü Et</button>
    </div>

    <div id="game-screen" style="display:none; animation: fadeIn 1s ease;">
        <div class="status-bar" style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.8rem;">
            <div style="color:#f5b942;"><i class="fas fa-key"></i> KOD: <b id="display-room-code">...</b></div>
            <div style="color:#2ed573;"><i class="fas fa-coins"></i> <span id="user-pts">0</span> PTS</div>
        </div>

        <div class="nursery" style="height:320px; background:#111; border-radius:25px; position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #222;">
            <img id="room-bg" src="https://images.unsplash.com/photo-1544126592-807daa2b565b?q=80&w=1000&auto=format&fit=crop" style="position:absolute; width:100%; height:100%; object-fit:cover; opacity:0.3; display:none;">
            <div id="baby-avatar" style="font-size: 7rem; z-index: 5; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));">üë∂</div>
            <img id="baby-suit" src="" style="position:absolute; width:180px; z-index:6; display:none;">
        </div>

        <div style="text-align:center; margin-top:20px;">
            <h3 id="baby-name-display" style="font-family:'Playfair Display', serif; color:#f5b942; margin:0;">Ad</h3>
            <p id="notification-text" style="font-size:0.75rem; color:#ff4757; font-weight:700; height:20px;"></p>
        </div>

        <div class="stats" style="margin-top:10px;">
            <div class="bar-label">ACLIQ: <span id="val-h">50</span>%</div>
            <div class="bar-bg"><div id="bar-h" class="bar-fill" style="background:#f5b942;"></div></div>
            
            <div class="bar-label" style="margin-top:10px;">SEVGƒ∞: <span id="val-l">50</span>%</div>
            <div class="bar-bg"><div id="bar-l" class="bar-fill" style="background:#ff4757;"></div></div>
        </div>

        <div style="display:flex; gap:10px; margin-top:25px;">
            <button class="action-btn" onclick="babyCare('hunger')"><i class="fas fa-apple-whole"></i> YEDƒ∞RT</button>
            <button class="action-btn" onclick="babyCare('love')"><i class="fas fa-heart"></i> OYNA</button>
        </div>

        <div class="market" style="margin-top:30px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div class="market-item" onclick="buyGift('cloth', 350, 'https://cdn-icons-png.flaticon.com/512/963/963861.png')">
                <i class="fas fa-shirt" style="font-size:2rem; color:#f5b942;"></i>
                <p>Paltar (350)</p>
            </div>
            <div class="market-item" onclick="buyGift('home', 1500, 'https://cdn-icons-png.flaticon.com/512/619/619153.png')">
                <i class="fas fa-house-chimney" style="font-size:2rem; color:#f5b942;"></i>
                <p>Yeni Ev (1500)</p>
            </div>
        </div>
    </div>
</div>

<style>
    .choice-btn { flex:1; padding:10px; background:#161822; border:1px solid #333; color:#888; border-radius:10px; cursor:pointer; font-weight:700; }
    .choice-btn.active { border-color:#f5b942; color:#f5b942; background:rgba(245,185,66,0.1); }
    .bar-label { font-size:0.7rem; font-weight:800; margin-bottom:5px; color:#c5a059; }
    .bar-bg { width:100%; height:8px; background:#000; border-radius:5px; overflow:hidden; }
    .bar-fill { height:100%; width:0%; transition:0.8s ease-out; }
    .action-btn { flex:1; padding:15px; background:#161822; border:1px solid #333; color:#fff; border-radius:15px; cursor:pointer; font-weight:700; font-size:0.8rem; }
    .action-btn:hover { border-color:#f5b942; }
    .market-item { background:#161822; padding:20px; border-radius:20px; border:1px solid #222; text-align:center; cursor:pointer; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
</style>

<script>
    // Firebase baƒülantƒ±sƒ± m√ºtl…ôq index.html-d…ô olmalƒ±dƒ±r, amma burada m√ºst…ôqil yoxlayƒ±rƒ±q
    if (!firebase.apps.length) {
        firebase.initializeApp({
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com"
        });
    }
    const dbRef = firebase.database();
    
    let currentRoom = null;
    let babySex = "boy";
    let myUser = localStorage.getItem('active_user') || "Qonaq";
    let myPts = parseInt(localStorage.getItem('active_pts')) || 0;

    function setGender(g) {
        babySex = g;
        document.getElementById('btn-boy').classList.toggle('active', g==='boy');
        document.getElementById('btn-girl').classList.toggle('active', g==='girl');
    }

    async function handleRoomAccess() {
        const roomCode = document.getElementById('room-code-input').value.trim().toLowerCase();
        if(!roomCode) return alert("Kod daxil edin!");

        currentRoom = roomCode;
        const ref = dbRef.ref('families/' + currentRoom);
        const snap = await ref.get();

        if(!snap.exists()) {
            // Otaq yoxdursa yaradƒ±lƒ±≈ü ekranƒ±nƒ± g√∂st…ôr
            document.getElementById('new-baby-setup').style.display = 'block';
            const bName = document.getElementById('baby-name-in').value.trim();
            if(!bName) return alert("K√∂rp…ôy…ô ad verin v…ô t…ôkrar Giri≈ü d√ºym…ôsini basƒ±n.");
            
            await ref.set({
                name: bName, gender: babySex, hunger: 100, love: 100,
                cloth: "", home: "", lastUpdate: Date.now()
            });
        }

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('display-room-code').innerText = currentRoom.toUpperCase();
        
        startLiveSync();
    }

    function startLiveSync() {
        const ref = dbRef.ref('families/' + currentRoom);
        
        ref.on('value', snap => {
            const data = snap.val();
            if(!data) return;

            // Stats yenil…ô
            document.getElementById('baby-name-display').innerText = data.name;
            document.getElementById('val-h').innerText = Math.floor(data.hunger);
            document.getElementById('bar-h').style.width = data.hunger + "%";
            document.getElementById('val-l').innerText = Math.floor(data.love);
            document.getElementById('bar-l').style.width = data.love + "%";
            document.getElementById('user-pts').innerText = myPts;

            // X…ôb…ôrdarlƒ±q sistemi (Ehtiyaclar)
            const notify = document.getElementById('notification-text');
            if(data.hunger < 30) notify.innerText = "‚ö†Ô∏è K√ñRP∆è √áOX ACDIR!";
            else if(data.love < 30) notify.innerText = "‚ö†Ô∏è K√ñRP∆è DARIXIR!";
            else notify.innerText = "";

            // G√∂r√ºn√º≈ü
            const avatar = document.getElementById('baby-avatar');
            avatar.innerText = (data.gender === 'boy') ? "üë¶" : "üëß";
            if(data.hunger < 20) avatar.innerText = "üò≠";

            if(data.cloth) { document.getElementById('baby-suit').src = data.cloth; document.getElementById('baby-suit').style.display = 'block'; }
            if(data.home) { document.getElementById('room-bg').src = data.home; document.getElementById('room-bg').style.display = 'block'; }
        });

        // Arxa planda acma m…ôntiqi (H…ôr d…ôf…ô kims…ô gir…ônd…ô zaman f…ôrqin…ô g√∂r…ô hesablanƒ±r)
        setInterval(() => {
            ref.transaction(current => {
                if(current) {
                    current.hunger = Math.max(0, current.hunger - 0.05); // Yava≈üca acƒ±r
                    current.love = Math.max(0, current.love - 0.03);
                }
                return current;
            });
        }, 10000);
    }

    function babyCare(type) {
        dbRef.ref('families/' + currentRoom).transaction(d => {
            if(d) d[type] = Math.min(100, d[type] + 15);
            return d;
        });
    }

    async function buyGift(type, cost, url) {
        if(myPts < cost) return alert("Kifay…ôt q…ôd…ôr PTS yoxdur!");
        
        myPts -= cost;
        localStorage.setItem('active_pts', myPts);
        await dbRef.ref('users/' + myUser + '/points').set(myPts);

        let update = {};
        if(type === 'cloth') update.cloth = url;
        if(type === 'home') update.home = url;
        await dbRef.ref('families/' + currentRoom).update(update);
        alert("H…ôdiyy…ô alƒ±ndƒ±!");
    }
</script>