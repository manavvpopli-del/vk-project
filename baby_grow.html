<div class="family-app" style="color: #e2e8f0; font-family: 'Montserrat', sans-serif; max-width: 450px; margin: auto;">
    
    <button id="pwa-btn" style="display:none; width:100%; padding:15px; background:#f5b942; border:none; border-radius:15px; font-weight:800; margin-bottom:20px; cursor:pointer;">
        <i class="fas fa-heart"></i> ANA EKRANA ƏLAVƏ ET
    </button>

    <div id="setup-area" class="glass-panel" style="background:rgba(20,22,30,0.9); padding:30px; border-radius:30px; border:1px solid #c5a059;">
        <h2 style="font-family:'Playfair Display'; color:#f5b942; text-align:center;">Ailə Ocağı</h2>
        
        <input type="text" id="partner-id" placeholder="Sevgilinin İstifadəçi Adı" style="width:100%; padding:15px; background:#000; border:1px solid #333; border-radius:12px; color:#fff; margin-bottom:15px; text-align:center;">
        
        <div id="new-baby-form" style="display:none; border-top:1px solid #333; padding-top:20px; margin-top:10px;">
            <input type="text" id="baby-n" placeholder="Körpəyə Ad Qoyun" style="width:100%; padding:15px; background:#000; border:1px solid #333; border-radius:12px; color:#fff; margin-bottom:15px; text-align:center;">
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="opt-btn" id="m-boy" onclick="setGender('boy')">OĞLAN</button>
                <button class="opt-btn" id="m-girl" onclick="setGender('girl')">QIZ</button>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="opt-btn" id="s-light" onclick="setSkin('light')">AÇIQ DƏRİ</button>
                <button class="opt-btn" id="s-dark" onclick="setSkin('dark')">TÜND DƏRİ</button>
            </div>
        </div>

        <button onclick="startFamilyLife()" style="width:100%; padding:18px; background:#f5b942; color:#000; border:none; border-radius:12px; font-weight:800; cursor:pointer;">HƏYATI BAŞLAT</button>
    </div>

    <div id="main-game" style="display:none; animation: fadeIn 1s ease;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div style="font-size:0.7rem; color:#f5b942;">VALİDEYNLƏR: <b id="parent-names">...</b></div>
            <div style="font-size:0.7rem; color:#2ed573;">PTS: <b id="user-pts">0</b></div>
        </div>

        <div class="cradle" style="height:300px; background:#111; border-radius:25px; position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden;">
            <img id="house-view" src="" style="position:absolute; width:100%; height:100%; object-fit:cover; opacity:0.4; display:none;">
            <img id="baby-view" src="" style="width:180px; z-index:2; transition: 0.5s;">
            <img id="cloth-view" src="" style="position:absolute; width:180px; z-index:3; display:none;">
        </div>

        <div style="margin-top:20px;">
            <h3 id="baby-title" style="text-align:center; color:#f5b942; font-family:'Playfair Display';">Ad</h3>
            <div class="bar-wrap">TOXLUQ: <span id="th">0%</span> <div class="bar"><div id="bh" class="inner"></div></div></div>
            <div class="bar-wrap">XOŞBƏXTLİK: <span id="tl">0%</span> <div class="bar"><div id="bl" class="inner" style="background:#ff4757;"></div></div></div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="opt-btn" onclick="babyAction('hunger')" style="flex:1;">YEDİRT</button>
            <button class="opt-btn" onclick="babyAction('love')" style="flex:1;">OYNA</button>
        </div>

        <div class="market" style="margin-top:30px; display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div class="market-card" onclick="buyItem('cloth', 300, 'https://i.ibb.co/m0f4kYm/suit.png')">
                <img src="https://i.ibb.co/m0f4kYm/suit.png" style="width:60px;">
                <p>Kostyum (300)</p>
            </div>
            <div class="market-card" onclick="buyItem('home', 1200, 'https://i.ibb.co/QjGfXvQ/modern-house.jpg')">
                <img src="https://i.ibb.co/QjGfXvQ/modern-house.jpg" style="width:60px;">
                <p>Ev (1200)</p>
            </div>
        </div>
    </div>
</div>

<style>
    .opt-btn { background:#161822; border:1px solid #333; color:#888; padding:10px; border-radius:10px; cursor:pointer; font-weight:700; transition:0.3s; }
    .opt-btn.active { border-color:#f5b942; color:#f5b942; }
    .bar-wrap { font-size:0.7rem; margin-bottom:10px; }
    .bar { width:100%; height:8px; background:#000; border-radius:5px; margin-top:5px; overflow:hidden; }
    .inner { height:100%; width:0%; background:#f5b942; transition:0.5s; }
    .market-card { background:#161822; padding:15px; border-radius:15px; border:1px solid #222; text-align:center; cursor:pointer; }
</style>

<script>
    // Firebase Bağlantısı (Müstəqil)
    if (!firebase.apps.length) {
        firebase.initializeApp({
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com"
        });
    }
    const babyDB = firebase.database();
    
    let activeFamilyId = null;
    let bGen = "boy";
    let bSkin = "light";
    let myName = localStorage.getItem('active_user') || "Qonaq";
    let myPts = parseInt(localStorage.getItem('active_pts')) || 0;

    function setGender(v) { bGen = v; document.getElementById('m-boy').className = v==='boy'?'opt-btn active':'opt-btn'; document.getElementById('m-girl').className = v==='girl'?'opt-btn active':'opt-btn'; }
    function setSkin(v) { bSkin = v; document.getElementById('s-light').className = v==='light'?'opt-btn active':'opt-btn'; document.getElementById('s-dark').className = v==='dark'?'opt-btn active':'opt-btn'; }

    async function startFamilyLife() {
        const partner = document.getElementById('partner-id').value.trim().toLowerCase();
        if(!partner || partner === myName) return alert("Düzgün tərəfdaş adı!");

        activeFamilyId = [myName, partner].sort().join("_");
        const ref = babyDB.ref('families/' + activeFamilyId);
        const snap = await ref.get();

        if(!snap.exists()) {
            document.getElementById('new-baby-form').style.display = 'block';
            const bName = document.getElementById('baby-n').value.trim();
            if(!bName) return; // İkinci dəfə basanda yaradacaq
            
            await ref.set({
                babyName: bName, gender: bGen, skin: bSkin,
                hunger: 50, love: 50, age: 0,
                cloth: "", home: "", parents: [myName, partner]
            });
        }

        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('main-game').style.display = 'block';
        
        // Real-time Sinxronizasiya
        ref.on('value', s => {
            const d = s.val();
            if(!d) return;
            document.getElementById('baby-title').innerText = d.babyName;
            document.getElementById('parent-names').innerText = d.parents.join(" & ");
            document.getElementById('user-pts').innerText = myPts;
            document.getElementById('bh').style.width = d.hunger + "%";
            document.getElementById('th').innerText = d.hunger + "%";
            document.getElementById('bl').style.width = d.love + "%";
            document.getElementById('tl').innerText = d.love + "%";
            
            const img = d.skin === 'light' ? 'https://i.ibb.co/LkhKzG9/baby-light.png' : 'https://i.ibb.co/YyYhYhY/baby-dark.png';
            document.getElementById('baby-view').src = img;
            
            if(d.cloth) { document.getElementById('cloth-view').src = d.cloth; document.getElementById('cloth-view').style.display = 'block'; }
            if(d.home) { document.getElementById('house-view').src = d.home; document.getElementById('house-view').style.display = 'block'; }
        });
    }

    function babyAction(t) {
        babyDB.ref('families/' + activeFamilyId).transaction(d => {
            if(d) d[t] = Math.min(100, (d[t] || 0) + 10);
            return d;
        });
    }

    async function buyItem(type, price, url) {
        if(myPts < price) return alert("Xalınız çatmır!");
        
        // Balansdan çıx və LocalStorage-i yenilə
        myPts -= price;
        localStorage.setItem('active_pts', myPts);
        await babyDB.ref('users/' + myName + '/points').set(myPts);

        let up = {};
        if(type === 'cloth') up.cloth = url;
        if(type === 'home') up.home = url;
        await babyDB.ref('families/' + activeFamilyId).update(up);
        alert("Alındı!");
    }
</script>